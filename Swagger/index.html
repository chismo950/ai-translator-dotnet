<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>API Docs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="/swagger/swagger-ui.css" />

    <style>
      .turnstile-panel {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 16px;
      }
      .turnstile-status {
        font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        color: #444;
        opacity: 0.9;
      }
      .ts-ok {
        color: #137333;
      }
      .ts-warn {
        color: #a94442;
      }
      .ts-muted {
        color: #666;
      }
      .cf-turnstile {
        transform: scale(0.95);
        transform-origin: left center;
      }
    </style>
  </head>
  <body>
    <div id="swagger-ui"></div>

    <script
      src="/swagger/swagger-ui-bundle.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="/swagger/swagger-ui-standalone-preset.js"
      crossorigin="anonymous"
    ></script>

    <script>
      (function () {
        // --- Config ---
        const swaggerJsonUrl = "/swagger/v1/swagger.json";
        const siteKeyEndpoint = "/_turnstile/sitekey"; // returns { siteKey, headerName }
        const PASS_HEADER = "X-Turnstile-Pass"; // must match server TurnstilePassOptions.HeaderName

        // --- State ---
        let turnstileHeaderName = "CF-Turnstile-Token"; // Turnstile token header (from server meta)
        let currentTurnstileToken = null; // Turnstile token (short-lived)
        let passToken = null; // short-lived pass issued by server
        let widgetId = null;

        // Optional manual gating (require user click)
        let manualArm = false;
        let lastSolvedAt = 0;
        const maxTokenAgeMs = 60_000;

        // --- DOM helpers ---
        function ensureTopbarPanel() {
          const topbar = document.querySelector("#swagger-ui .topbar .wrapper");
          if (!topbar) return null;

          let panel = document.querySelector("#turnstile-panel");
          if (!panel) {
            panel = document.createElement("div");
            panel.id = "turnstile-panel";
            panel.className = "turnstile-panel";

            const widgetDiv = document.createElement("div");
            widgetDiv.id = "turnstile-widget";
            widgetDiv.className = "cf-turnstile";

            const status = document.createElement("div");
            status.id = "turnstile-status";
            status.className = "turnstile-status ts-muted";
            status.textContent = "Turnstile: click Verify (or use server pass)";

            const verifyBtn = document.createElement("button");
            verifyBtn.textContent = "Verify";
            verifyBtn.type = "button";
            verifyBtn.style.cursor = "pointer";
            verifyBtn.onclick = () => {
              manualArm = true;
              lastSolvedAt = 0;
              currentTurnstileToken = null;
              setStatus("Turnstile: please complete verification...", null);
              if (window.turnstile && widgetId !== null)
                window.turnstile.reset(widgetId);
            };

            const refreshBtn = document.createElement("button");
            refreshBtn.textContent = "Refresh";
            refreshBtn.type = "button";
            refreshBtn.style.cursor = "pointer";
            refreshBtn.onclick = () => {
              currentTurnstileToken = null;
              setStatus("Turnstile: refreshed — click Verify to proceed", null);
              if (window.turnstile && widgetId !== null)
                window.turnstile.reset(widgetId);
            };

            const clearPassBtn = document.createElement("button");
            clearPassBtn.textContent = "Clear Pass";
            clearPassBtn.type = "button";
            clearPassBtn.style.cursor = "pointer";
            clearPassBtn.onclick = () => {
              passToken = null;
              setStatus("Turnstile: pass cleared — please Verify", null);
            };

            panel.appendChild(widgetDiv);
            panel.appendChild(status);
            panel.appendChild(verifyBtn);
            panel.appendChild(refreshBtn);
            panel.appendChild(clearPassBtn);
            topbar.appendChild(panel);
          }
          return panel;
        }

        function setStatus(text, ok) {
          const s = document.getElementById("turnstile-status");
          if (!s) return;
          s.textContent = text;
          s.className =
            "turnstile-status " +
            (ok === true ? "ts-ok" : ok === false ? "ts-warn" : "ts-muted");
        }

        // --- Load Turnstile API ---
        function loadTurnstileApi() {
          return new Promise((resolve, reject) => {
            if (window.turnstile) return resolve(window.turnstile);
            const s = document.createElement("script");
            s.src =
              "https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit";
            s.async = true;
            s.defer = true;
            s.onload = () => resolve(window.turnstile);
            s.onerror = () => reject(new Error("Failed to load Turnstile API"));
            document.head.appendChild(s);
          });
        }

        // --- Fetch site key meta ---
        async function fetchSiteKey() {
          const res = await fetch(siteKeyEndpoint, { cache: "no-store" });
          if (!res.ok) throw new Error("Failed to fetch site key");
          return res.json();
        }

        // --- Render Turnstile widget ---
        function renderTurnstile(siteKey) {
          const container = document.getElementById("turnstile-widget");
          if (!container || !window.turnstile) return;
          container.innerHTML = "";

          widgetId = window.turnstile.render(container, {
            sitekey: siteKey,
            action: "swagger",
            callback: function (token) {
              // Accept token only if user clicked Verify
              if (!manualArm) {
                currentTurnstileToken = null;
                setStatus("Turnstile: click Verify to generate a token", false);
                return;
              }
              currentTurnstileToken = token || null;
              lastSolvedAt = Date.now();
              manualArm = false;
              if (currentTurnstileToken)
                setStatus("Turnstile: verified (manual)", true);
            },
            "expired-callback": function () {
              currentTurnstileToken = null;
              setStatus("Turnstile: expired — click Verify", false);
            },
            "error-callback": function () {
              currentTurnstileToken = null;
              setStatus("Turnstile: error — click Verify", false);
            },
            theme: "auto",
          });
        }

        // --- Helpers for headers ---
        function getHeader(res, name) {
          const headers = res && res.headers;
          if (!headers) return null;
          const lower = name.toLowerCase();

          try {
            // Fetch Headers API
            if (typeof headers.get === "function") {
              return headers.get(name) || headers.get(lower) || null;
            }
            // Plain object format (swagger-client sometimes flattens)
            for (const key in headers) {
              if (
                Object.prototype.hasOwnProperty.call(headers, key) &&
                key.toLowerCase() === lower
              ) {
                const v = headers[key];
                if (Array.isArray(v)) return v[0] ?? null;
                if (v && typeof v === "object" && "value" in v) return v.value;
                return v ?? null;
              }
            }
          } catch (_) {
            /* ignore */
          }
          return null;
        }

        // --- Interceptors ---
        const requestInterceptor = function (req) {
          const href = new URL(req.url, window.location.origin);
          const path = href.pathname || "";

          // Allowlist swagger assets + sitekey endpoint
          const isSwaggerAsset =
            path.startsWith("/swagger/") ||
            path.endsWith("/swagger/v1/swagger.json");
          const isTurnstileMeta = path === "/_turnstile/sitekey";
          if (isSwaggerAsset || isTurnstileMeta) {
            return req;
          }

          // Only gate your business API
          const isApiCall = path.startsWith("/v1/");
          if (!isApiCall) {
            return req;
          }

          // Use server-issued pass first
          if (passToken) {
            req.headers[PASS_HEADER] = passToken;
            return req;
          }

          // Otherwise require a fresh token (after user clicked Verify)
          const fresh =
            currentTurnstileToken && Date.now() - lastSolvedAt <= maxTokenAgeMs;
          if (!fresh) {
            setStatus("Turnstile: click Verify to proceed", false);
            throw new Error("Turnstile token missing or stale");
          }
          if (turnstileHeaderName) {
            req.headers[turnstileHeaderName] = currentTurnstileToken;
          }
          return req;
        };

        const responseInterceptor = function (res) {
          try {
            // Capture new pass if server issued one
            const issued = getHeader(res, PASS_HEADER);
            if (issued && typeof issued === "string") {
              passToken = issued;
              setStatus("Server pass active (using " + PASS_HEADER + ")", true);
            }

            // On auth/verification errors, clear pass and prompt
            if (res && (res.status === 400 || res.status === 403)) {
              passToken = null;
              setStatus("Verification required — please click Verify", false);
              if (window.turnstile && widgetId !== null)
                window.turnstile.reset(widgetId);
            }
          } catch (e) {
            // Never break Swagger rendering due to header parsing issues
            console.warn("responseInterceptor warning:", e);
          }
          return res;
        };

        // --- Start Swagger UI ---
        function startSwaggerUI() {
          const ui = SwaggerUIBundle({
            url: swaggerJsonUrl,
            dom_id: "#swagger-ui",
            deepLinking: true,
            presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
            plugins: [SwaggerUIBundle.plugins.DownloadUrl],
            layout: "StandaloneLayout",
            requestInterceptor: requestInterceptor,
            responseInterceptor: responseInterceptor,
          });

          const observer = new MutationObserver(() => {
            if (ensureTopbarPanel()) observer.disconnect();
          });
          observer.observe(document.getElementById("swagger-ui"), {
            childList: true,
            subtree: true,
          });

          window.ui = ui;
        }

        // --- Main bootstrap ---
        (async function init() {
          startSwaggerUI();

          try {
            const meta = await fetchSiteKey();
            turnstileHeaderName =
              meta && meta.headerName ? meta.headerName : turnstileHeaderName;

            ensureTopbarPanel();

            await loadTurnstileApi();
            if (!meta || !meta.siteKey) {
              setStatus("Turnstile: siteKey missing on server", false);
              return;
            }
            renderTurnstile(meta.siteKey);
            setStatus("Turnstile: click Verify (or use server pass)", null);
          } catch (e) {
            console.error(e);
            setStatus("Turnstile: initialization failed", false);
          }
        })();
      })();
    </script>
  </body>
</html>
